<html>
<head>
<title>Google Tag Manager Content Security Policy Generator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

<style>
.card {margin-bottom: 16px; border-radius: 8px;padding:0;}
.card-contents {margin-bottom: 16px; padding-bottom: 8px; padding-top: 16px; padding-left: 24px; padding-right: 24px;}
.card-title {margin: -16px -24px 0; padding: 15px 24px 16px;}
h3.field-group-title {color: rgba(0,0,0,.54);font-size: 12px;letter-spacing: .3px;padding-bottom: 1px;padding-top: 2px;}
div.field-group {border-radius: 4px;box-shadow: 0 0 0 1px #dadce0; min-height: 56px;padding: 15px;margin-bottom: 20px;}
.indented {margin-left: 35px;}
.directive {display:block}
.directive .name {font-weight: bold;}
.directive span.highlight {background-color: #fff3cd;}
.offcanvas-header {justify-content: left;}
.offcanvas-header h5 {margin-left: 25px;}
.offcanvas.offcanvas-end {width: 50%}
ul.additional-tlds {list-style: none;}
.form-check a {font-size: 10pt; padding-left: 20px;}
a.disabled {color: #bfbfbf;}
a.enabled {color: inherit;}
</style>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-M234BJS');</script>
<!-- End Google Tag Manager -->

</head>

<body style="background-color: #f1f3f4; font-family: 'Google Sans',Roboto,Helvetica,Arial,sans-serif;">

<header style="min-height: 112px; background-color: #fff; box-shadow: 0 1px 4px 0 rgb(0 0 0 / 20%), 0 4px 5px 0 rgb(0 0 0 / 14%), 0 2px 10px -1px rgb(0 0 0 / 12%)">
	<div class="container">
	  <div class="row">
		<div class="col">
			<h1 style="font-size: 16pt; padding-top: 30px;">

<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" version="1.1" viewBox="0 0 32.288136 43.050846" preserveAspectRatio="xMidYMid meet" id="svg8" sodipodi:docname="Editor_protection.svg" width="32.288136" height="43.050846" style="stroke-linecap:round;stroke-linejoin:round;vertical-align: bottom;margin-right: 10px;" inkscape:version="0.92.4 (5da689c313, 2019-01-14)">
  <metadata id="metadata14"> <rdf:RDF><cc:Work rdf:about=""> <dc:format>image/svg+xml</dc:format> <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /> <dc:title /> </cc:Work> </rdf:RDF> </metadata>
  <defs id="defs12" />
  <sodipodi:namedview pagecolor="#ffffff" bordercolor="#66bdc1" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1920" inkscape:window-height="1017" id="namedview10" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:pagecheckerboard="true" showborder="true" inkscape:showpageshadow="true" inkscape:zoom="22.627417" inkscape:cx="19.311881" inkscape:cy="19.004912" inkscape:window-x="1912" inkscape:window-y="32" inkscape:window-maximized="1" inkscape:current-layer="svg8" />
  <rect style="fill:none;stroke:#808080;stroke-width:5.38135576" x="5.3813558" y="2.6906779" width="21.525423" height="32.288136" rx="10.762712" ry="10.762712" id="rect2" />
  <rect x="0" y="17.877047" width="32.288136" height="25.173801" rx="2.6906779" ry="2.51738" style="fill:#3684eb;stroke-width:2.08206964;fill-opacity:1" id="rect4" />
</svg>

		  Content Security Policy Generator
		  <span style="font-size: 12pt">for <a href="https://tagmanager.google.com/" target="_blank">Google Tag Manager</a></span></h1>
		</div>
	  </div>
	</div>
</header>

<article style="padding: 24px 24px 24px 16px">
	<div class="container text-left">

	  <div class="row align-items-start input">
		<div class="col card">
			<div class="card-contents">
			  <div class="card-title">Usage</div>
			  <div class="indented">
				<p>This utility is designed to help take some of the frustration out of deploying Google Tag Manager on a website that has a Content Security Policy defined. It can be accessed at <a href="https://ga4-content-security-policy.web.app/" target="_blank">https://ga4-content-security-policy.web.app/</a>. You should understand how Content Security Policies work before using this tool.</p>
				<p>
					<ol>
						<li>Choose the GTM tags and features below that are in use in your GTM container.</li>
						<li>For Google Analytics 4 with Google Signals enabled, choose additional country-specific Google domains that should be included in your implementation. Identify the country-specific Google domains by running a report of Users by Country</li>
						<li>For Floodlight tags, enter your Floodlight Config ID</li>
						<li>Integrate the CSP directives generated in the Output section below into the site's Content Security Policy.</li>
					</ol>
			  </div>
		    </div>
		</div>
	  </div>

	  <div class="row align-items-start input">
		<div class="col card">
			<div class="card-contents">
			  <div class="card-title">Settings</div>

				<h3 class="field-group-title">Google Tag Manager</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-gtm-preview-mode" checked>
					  <label class="form-check-label" for="setting-gtm-preview-mode">GTM Preview Mode</label>
					</div>
				</div>


				<h3 class="field-group-title">Google Analytics Tags</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-universal-analytics">
					  <label class="form-check-label" for="setting-universal-analytics">Universal Analytics</label>
					</div>

					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-google-analytics-4">
					  <label class="form-check-label" for="setting-google-analytics-4">Google Analytics 4</label>
					</div>

					<div class="form-check form-switch indented">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-google-signals" disabled>
					  <label class="form-check-label" for="setting-google-signals">Google Signals</label>
					  
					  <a href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" class="open-tlds disabled">
						Choose Additional Google Country-Code TLDs
					  </a>
					  
					</div>
					
					
				</div>

				<h3 class="field-group-title">Google Optimize Tags</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-google-optimize">
					  <label class="form-check-label" for="setting-google-optimize">Google Optimize</label>
					  <a target="_blank" class="disabled" href="https://www.seerinteractive.com/insights/google-optimize-going-away">
						...is going away 30-Sep 2023
					  </a>
					</div>
				</div>

				<h3 class="field-group-title">Google Ads Tags</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-google-ads-conversion">
					  <label class="form-check-label" for="setting-google-ads-conversion">Google Ads Conversion</label>
					</div>

					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-google-ads-remarketing">
					  <label class="form-check-label" for="setting-google-ads-remarketing">Google Ads Remarketing</label>
					</div>
				</div>

				<h3 class="field-group-title">Floodlight Tags</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-floodlight">
					  <label class="form-check-label" for="setting-floodlight">Floodlight</label>
					</div>
							 
					<input class="form-control indented" type="text" placeholder="Config ID" aria-label="default input example" id="setting-floodlight-config-id" disabled style="max-width: 230px;">
					
					<div class="form-check form-switch indented">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-floodlight-custom-scripts" disabled>
					  <label class="form-check-label" for="setting-floodlight-custom-scripts">Custom Scripts Beacons</label>
					</div>
					
					<div class="form-check form-switch indented">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-floodlight-image-tags" disabled>
					  <label class="form-check-label" for="setting-floodlight-image-tags">Image Tags</label>
					</div>
					
					<div class="form-check form-switch indented">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-floodlight-consent-mode" disabled>
					  <label class="form-check-label" for="setting-floodlight-consent-mode">Consent Mode</label>
					</div>
				</div>
				
				<h3 class="field-group-title">Meta/Facebook</h3>
				<div class="field-group">
					<div class="form-check form-switch">
					  <input class="form-check-input" type="checkbox" role="switch" id="setting-meta-pixel">
					  <label class="form-check-label" for="setting-meta-pixel">Meta/Facebook Pixel</label>
					</div>
				</div>
				
			</div>
		</div>
	  </div>

	  <div class="row align-items-start">
		<div class="col card">
		  <div class="card-contents">
			  <div class="card-title">Output</div>
			  <div class="form-control output" style="font-family: monospace; font-size: .75em;"></div>
		  </div>
		</div>
	  </div>
	  
	  <div class="row align-items-start">
		<div class="col card">
		  <div class="card-contents">
			  <div class="card-title">References</div>
			  <ul class="">
				<li><a target="_blank" href="https://developers.google.com/tag-platform/tag-manager/web/csp">https://developers.google.com/tag-platform/tag-manager/web/csp</a></li>
				<li><a target="_blank" href="https://www.google.com/supported_domains">https://www.google.com/supported_domains</a></li>
				<li><a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP</a></li>
				<li><a target="_blank" href="https://en.wikipedia.org/wiki/Country_code_top-level_domain">https://en.wikipedia.org/wiki/Country_code_top-level_domain</a></li>
				<li><a target="_blank" href="https://josephpinder.com/blog/facebook-pixel-is-slowing-down-your-website-and-how-to-fix-it-securely">https://josephpinder.com/blog/facebook-pixel-is-slowing-down-your-website-and-how-to-fix-it-securely</a></li>
				<li><a target="_blank" href="https://developers.facebook.com/docs/meta-pixel/advanced/#content-security-policy">https://developers.facebook.com/docs/meta-pixel/advanced/#content-security-policy</a></li>
			  </ul>
			  </div>
		  </div>
		</div>
	  </div>
	  
	</div>
</article>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	<h5 class="offcanvas-title" id="offcanvasRightLabel">Additional cc-TLDs</h5>
  </div>
  <div class="offcanvas-body">
	<p class="indented"><a href="#" id="tld-select-all">Select All</a> / <a href="#" id="tld-select-none">Select None</a></p>
    <ul class="additional-tlds">
	</ul>
  </div>
</div>

<script>

var directives = ['script-src', 'img-src', 'frame-src', 'style-src', 'connect-src', 'font-src'];
var inputs = document.getElementsByTagName('input');
var additionalTlds = {
	'google.ad': 'Andorra',
	'google.ae': 'United Arab Emirates',
	'google.com.af': 'Afghanistan',
	'google.com.ag': 'Antigua and Barbuda',
	'google.com.ai': 'Anguilla',
	'google.al': 'Albania',
	'google.am': 'Armenia',
	'google.co.ao': 'Angola',
	'google.com.ar': 'Argentina',
	'google.as': 'American Samoa',
	'google.at': 'Austria',
	'google.com.au': 'Australia',
	'google.az': 'Azerbaijan',
	'google.ba': 'Bosnia and Herzegovina',
	'google.com.bd': 'Bangladesh',
	'google.be': 'Belgium',
	'google.bf': 'Burkina Faso',
	'google.bg': 'Bulgaria',
	'google.com.bh': 'Bahrain',
	'google.bi': 'Burundi',
	'google.bj': 'Benin',
	'google.com.bn': 'Brunei',
	'google.com.bo': 'Bolivia',
	'google.com.br': 'Brazil',
	'google.bs': 'Bahamas',
	'google.bt': 'Bhutan',
	'google.co.bw': 'Botswana',
	'google.by': 'Belarus',
	'google.com.bz': 'Belize',
	'google.ca': 'Canada',
	'google.cd': 'Democratic Republic of the Congo',
	'google.cf': 'Central African Republic',
	'google.cg': 'Congo',
	'google.ch': 'Switzerland',
	'google.ci': 'Ivory Coast',
	'google.co.ck': 'Cook Islands',
	'google.cl': 'Chile',
	'google.cm': 'Cameroon',
	'google.cn': 'China',
	'google.com.co': 'Colombia',
	'google.co.cr': 'Costa Rica',
	'google.com.cu': 'Cuba',
	'google.cv': 'Cape Verde',
	'google.com.cy': 'Cyprus',
	'google.cz': 'Czech Republic',
	'google.de': 'Germany',
	'google.dj': 'Djibouti',
	'google.dk': 'Denmark',
	'google.dm': 'Dominica',
	'google.com.do': 'Dominican Republic',
	'google.dz': 'Algeria',
	'google.com.ec': 'Ecuador',
	'google.ee': 'Estonia',
	'google.com.eg': 'Egypt',
	'google.es': 'Spain',
	'google.com.et': 'Ethiopia',
	'google.fi': 'Finland',
	'google.com.fj': 'Fiji',
	'google.fm': 'Federated States of Micronesia',
	'google.fr': 'France',
	'google.ga': 'Gabon',
	'google.ge': 'Georgia',
	'google.gg': 'Guernsey',
	'google.com.gh': 'Ghana',
	'google.com.gi': 'Gibraltar	',
	'google.gl': 'Greenland',
	'google.gm': 'Gambia',
	'google.gr': 'Greece',
	'google.com.gt': 'Guatemala',
	'google.gy': '',
	'google.com.hk': '',
	'google.hn': '',
	'google.hr': '',
	'google.ht': '',
	'google.hu': '',
	'google.co.id': '',
	'google.ie': '',
	'google.co.il': '',
	'google.im': '',
	'google.co.in': '',
	'google.iq': '',
	'google.is': '',
	'google.it': '',
	'google.je': '',
	'google.com.jm': '',
	'google.jo': '',
	'google.co.jp': 'Japan',
	'google.co.ke': '',
	'google.com.kh': '',
	'google.ki': '',
	'google.kg': '',
	'google.co.kr': 'Korea',
	'google.com.kw': '',
	'google.kz': '',
	'google.la': '',
	'google.com.lb': '',
	'google.li': '',
	'google.lk': '',
	'google.co.ls': '',
	'google.lt': '',
	'google.lu': '',
	'google.lv': '',
	'google.com.ly': '',
	'google.co.ma': '',
	'google.md': '',
	'google.me': '',
	'google.mg': '',
	'google.mk': '',
	'google.ml': '',
	'google.com.mm': '',
	'google.mn': '',
	'google.ms': '',
	'google.com.mt': '',
	'google.mu': '',
	'google.mv': '',
	'google.mw': '',
	'google.com.mx': 'Mexico',
	'google.com.my': '',
	'google.co.mz': '',
	'google.com.na': '',
	'google.com.ng': '',
	'google.com.ni': '',
	'google.ne': '',
	'google.nl': '',
	'google.no': '',
	'google.com.np': '',
	'google.nr': '',
	'google.nu': '',
	'google.co.nz': '',
	'google.com.om': '',
	'google.com.pa': '',
	'google.com.pe': '',
	'google.com.pg': '',
	'google.com.ph': '',
	'google.com.pk': '',
	'google.pl': '',
	'google.pn': '',
	'google.com.pr': '',
	'google.ps': '',
	'google.pt': '',
	'google.com.py': '',
	'google.com.qa': '',
	'google.ro': 'Romania',
	'google.ru': 'Russia',
	'google.rw': 'Rwanda',
	'google.com.sa': 'Saudi Arabia	',
	'google.com.sb': 'Solomon Islands',
	'google.sc': 'Seychelles',
	'google.se': 'Sweden',
	'google.com.sg': 'Singapore',
	'google.sh': 'Saint Helena, Ascension and Tristan da Cunha',
	'google.si': 'Slovenia',
	'google.sk': 'Slovakia',
	'google.com.sl': 'Sierra Leone	',
	'google.sn': 'Senegal',
	'google.so': 'Somalia',
	'google.sm': 'San Marino',
	'google.sr': 'Suriname',
	'google.st': 'São Tomé and Príncipe',
	'google.com.sv': 'El Salvador',
	'google.td': 'Chad',
	'google.tg': 'Togo',
	'google.co.th': 'Thailand',
	'google.com.tj': 'Tajikistan',
	'google.tl': 'East Timor',
	'google.tm': 'Turkmen',
	'google.tn': 'Tunisia',
	'google.to': 'Tonga',
	'google.com.tr': 'Turkey',
	'google.tt': 'Trinidad and Tobago',
	'google.com.tw': 'Taiwan',
	'google.co.tz': 'Tanzania',
	'google.com.ua': 'Ukraine',
	'google.co.ug': 'Uganda',
	'google.co.uk': 'United Kingdom',
	'google.com.uy': 'Uruguay',
	'google.co.uz': 'Uzbekistan',
	'google.com.vc': 'Saint Vincent and the Grenadines',
	'google.co.ve': 'Venezuela',
	'google.vg': 'Virgin Islands (British)',
	'google.co.vi': 'Virgin Islands	(US)',
	'google.com.vn': 'Vietnam',
	'google.vu': 'Vanuatu',
	'google.ws': 'Samoa',
	'google.rs': 'Serbia',
	'google.co.za': 'South Africa',
	'google.co.zm': 'Zambia',
	'google.co.zw': 'Zimbabwe',
	'google.cat': ''
};

var optionDirectives = {

	'gtm-preview-mode': {
	  'script-src': ['https://tagmanager.google.com'],
	  'style-src': ['https://tagmanager.google.com', 'https://fonts.googleapis.com'],
	  'img-src': ['https://ssl.gstatic.com', 'https://www.gstatic.com'],
	  'font-src': ['https://fonts.gstatic.com', 'data:']
	},

	'universal-analytics-tag': {
	  'script-src': ['https://www.google-analytics.com', 'https://ssl.google-analytics.com'],
	  'img-src': ['https://www.google-analytics.com'],
	  'connect-src': ['https://www.google-analytics.com']
	},

	'google-analytics-4-tag': {
	  'script-src':  ['https://*.googletagmanager.com'],
	  'img-src':     ['https://*.google-analytics.com','https://*.googletagmanager.com'],
	  'connect-src': ['https://*.google-analytics.com', 'https://*.analytics.google.com', 'https://*.googletagmanager.com']
	},

	'google-analytics-4-with-google-signals': {
	  'script-src':  ['https://*.googletagmanager.com'],
	  'img-src':     ['https://*.google-analytics.com', 'https://*.analytics.google.com', 'https://*.googletagmanager.com', 'https://*.g.doubleclick.net', 'https://*.google.com', 'https://*.google.TLD'],
	  'connect-src': ['https://*.google-analytics.com', 'https://*.analytics.google.com', 'https://*.googletagmanager.com', 'https://*.g.doubleclick.net', 'https://*.google.com', 'https://*.google.TLD']
	},

	'google-optimize-tag': {
	  'script-src': ['https://www.google-analytics.com']
	},

	'google-ads-conversion-tag': {
	  'script-src': ['https://www.googleadservices.com', 'https://www.google.com'],
	  'img-src': ['https://googleads.g.doubleclick.net', 'https://www.google.com']
	},

	'google-ads-remarketing-tag': {
	  'script-src': ['https://www.googleadservices.com', 'https://googleads.g.doubleclick.net', 'https://www.google.com'],
	  'img-src': ['https://www.google.com'],
	  'frame-src': ['https://bid.g.doubleclick.net']
	},

	'floodlight-tag': {
	  'img-src': ['https://FLOODLIGHT-CONFIG-ID.fls.doubleclick.net']
	},

	'floodlight-custom-scripts': {
	  'frame-src': ['https://FLOODLIGHT-CONFIG-ID.fls.doubleclick.net']
	},

	'floodlight-image-tags': {
	  'img-src': ['https://ad.doubleclick.net']
	},

	'floodlight-consent-mode': {
	  'img-src': ['https://ade.googlesyndication.com']
	},

	'meta-pixel': {
	  'script-src': ['https://connect.facebook.net'],
	  'connect-src': ['https://www.facebook.com']
	},
}

var getDirectiveWithReplacements = function(directive, search, replacement) {
  for (var i = 0; i < directive.length; i++) {
	var directiveItem = directive[i];
	if (directiveItem == search) {
	  directive[i] = replacement;
	}
  }
  return directive;
}

var buildCspDirectives = function(options) {
  var cspDirectives = {
    'script-src': [],
    'style-src': [],
	'img-src': [],
	'frame-src': [],
	'connect-src': [],
	'font-src': []
  };
  options.forEach(function(option) {
    directives.forEach(function(directive) {
	  if (optionDirectives[option][directive]) {
		var newDirective = optionDirectives[option][directive].slice();

		// add additional CC-TLDs for GA4/Signals
		if (option == 'google-analytics-4-with-google-signals' && ['img-src', 'connect-src'].includes(directive)) {
		  var additionalTlds = collectAdditionalTlds();
		  if (additionalTlds.length) {
			newDirective = getDirectiveWithReplacements(newDirective, 'https://*.google.TLD', additionalTlds.join(' '));
		  }
		}
		if (['floodlight-tag', 'floodlight-custom-scripts'].includes(option) && ['img-src', 'frame-src'].includes(directive)) {
		  var floodlightConfigId = document.querySelector('#setting-floodlight-config-id').value;
console.log(option, directive, floodlightConfigId);
		  if (floodlightConfigId) {
		    var search = 'https://FLOODLIGHT-CONFIG-ID.fls.doubleclick.net';
		    var replacement = search.replace('FLOODLIGHT-CONFIG-ID', floodlightConfigId);
		    newDirective = getDirectiveWithReplacements(newDirective, search, replacement);
		  }
		}
	    cspDirectives[directive] = cspDirectives[directive].concat(newDirective);
	  }
	});
  });
  return cspDirectives;
}

var outputCspDirectives = function(directives) {
  var output = '';
  Object.keys(directives).forEach(function(key){
    var entries = directives[key];
	if (entries.length) {
	  if (output) output += "\n";
	  entries.forEach(function(entry, i) {
	    if (entry.includes('FLOODLIGHT-CONFIG-ID') || entry.includes('.TLD')) {
		  entries[i] = '<span class="highlight">' + entry + '</span>';
		}
	  });
      output += '<div class="directive"> <span class="name">' + key+'</span>: ' + entries.join(' ') + ';</div>';
	}
  });
  return output;
};

var getDirectiveOptionsFromSettings = function() {
  var options = [];
  var mappings = {
    'setting-gtm-preview-mode': 'gtm-preview-mode',
	'setting-universal-analytics': 'universal-analytics-tag',
	'setting-google-analytics-4': 'google-analytics-4-tag',
	'setting-google-signals': 'google-analytics-4-with-google-signals',
	'setting-google-optimize': 'google-optimize-tag',
	'setting-google-ads-conversion': 'google-ads-conversion-tag',
	'setting-google-ads-remarketing': 'google-ads-remarketing-tag',
	'setting-floodlight': 'floodlight-tag',
	'setting-floodlight-custom-scripts': 'floodlight-custom-scripts',
	'setting-floodlight-image-tags': 'floodlight-image-tags',
	'setting-floodlight-consent-mode': 'floodlight-consent-mode',
	'setting-meta-pixel': 'meta-pixel'
  };
  for(var i = 0; i < inputs.length; i++) {
    var input = inputs[i];
    if (mappings[input.id] && !input.disabled && input.checked) {
	  options.push(mappings[input.id]);
	}
  }
  return options;
}

var update = function() {
  var out = outputCspDirectives(buildCspDirectives(getDirectiveOptionsFromSettings()));
  document.querySelector('.output').innerHTML = out;
};

var collectAdditionalTlds = function() {
  var selectedTlds = [];
  var inputs = document.querySelectorAll('.additional-tld input');
  for (var i = 0; i < inputs.length; i++) {
	var input = inputs[i];
	if (input.checked) {
	  var tld = input.id.replace('setting-additional-tld_', '').replace('-', '.').replace('-', '.');
	  selectedTlds.push('https://*.' + tld);
	}
  } 
  return selectedTlds;
}

var tldList = document.querySelector('.additional-tlds');
var tldListItem = '<li class="additional-tld"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="setting-additional-tld-id"><label class="form-check-label" for="setting-additional-tld-id">[LABEL]</label></div></li>'

var tlds = Object.keys(additionalTlds);
var countryNames = Object.values(additionalTlds);
for(var i = 0; i < tlds.length; i++) {
  tld = tlds[i];
  var countryName = countryNames[i];
  var label = (countryName)?(tld + ' (' + countryName  + ')'):(tld);
  var tldCleansed = tld.replace('.', '-').replace('.', '-');
  var tldId = 'setting-additional-tld_' + tldCleansed;
  var countryListItem = tldListItem.replace('[LABEL]', label).replace('setting-additional-tld-id', tldId).replace('setting-additional-tld-id', tldId);
  tldList.insertAdjacentHTML('beforeend', countryListItem);
}

for(var i = 0; i < inputs.length; i++) {
  var input = inputs[i];
  input.addEventListener('change', function(e) {
    var el = e.target;
	if (el.checked) {
		if (el.id == 'setting-google-analytics-4') {
		  // enable google-signals toggle
		  document.getElementById('setting-google-signals').disabled = false;
		}
		if (el.id == 'setting-floodlight') {
		  document.getElementById('setting-floodlight-config-id').disabled = false;
		  document.getElementById('setting-floodlight-custom-scripts').disabled = false;
		  document.getElementById('setting-floodlight-image-tags').disabled = false;
		  document.getElementById('setting-floodlight-consent-mode').disabled = false;
		}
		if (el.id == 'setting-google-signals') {
		  // enable tld link
		  var link = document.querySelector('.open-tlds');
		  link.classList.remove("disabled");
		}
	} else {
		if (el.id == 'setting-google-analytics-4') {
		  // dis google-signals toggle
		  document.getElementById('setting-google-signals').disabled = true;
		}
		if (el.id == 'setting-floodlight') {
		  document.getElementById('setting-floodlight-config-id').disabled = true;
		  document.getElementById('setting-floodlight-custom-scripts').disabled = true;
		  document.getElementById('setting-floodlight-image-tags').disabled = true;
		  document.getElementById('setting-floodlight-consent-mode').disabled = true;
		}
		if (el.id == 'setting-google-signals') {
		  // enable tld link
		  var link = document.querySelector('.open-tlds');
		  link.classList.add("disabled");
		}
	}
	
	update();
  });
}

document.querySelector('#tld-select-all').addEventListener('click', function(e) {
  e.preventDefault();
  var tlds = document.querySelectorAll('.additional-tld input');
  tlds.forEach(function(tld) {
	tld.checked = 'checked';
  });
  update();
});

document.querySelector('#tld-select-none').addEventListener('click', function(e) {
  e.preventDefault();
  var tlds = document.querySelectorAll('.additional-tld input');
  tlds.forEach(function(tld) {
	tld.checked = false;
  });
  update();
});


update();

</script>

<footer style="text-align: center; font-size: 10pt; color: rgba(0, 0, 0, 0.54)">
  <div class="container">
  This tool is provided free of charge under the Apache License, Version 2.0; No support is provided. There is no guarantee of correctness; You are responsible for the security of your website, and the websites you oversee; This page is not produced by, or associated with, Google in any way; Padlock icon by User:Krzysiek_123456789 - Own work, Public Domain, <a target="_blank" href="https://commons.wikimedia.org/w/index.php?curid=80785665">https://commons.wikimedia.org/w/index.php?curid=80785665</a>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

</body>
</html>